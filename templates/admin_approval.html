<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Assistant', sans-serif; background-color: #0f172a; color: #f8fafc; padding: 20px; }
        .rule-card { transition: all 0.3s ease; }
        .rule-approved { border-color: #10b981 !important; background: rgba(16, 185, 129, 0.05) !important; }
        .rule-rejected { border-color: #ef4444 !important; background: rgba(239, 68, 68, 0.05) !important; }
        .modal { backdrop-filter: blur(8px); background-color: rgba(15, 23, 42, 0.8); }
        select, input { background-color: #1e293b !important; color: white !important; border: 1px solid #334155 !important; }
    </style>
</head>
<body>
    <div class="flex justify-between items-center mb-6 bg-slate-900 p-6 rounded-2xl border border-slate-800 shadow-xl">
        <div>
            <h1 class="text-2xl font-bold text-indigo-400">× ×™×”×•×œ ×ª×•×¨ ×—×•×§×•×ª</h1>
            <p class="text-slate-500 text-sm">××™×©×•×¨, ×¢×¨×™×›×” ×•××¢×§×‘ ××—×¨ ×‘×§×©×•×ª</p>
        </div>
        <button onclick="commitAll()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-8 py-3 rounded-xl font-bold transition-all shadow-lg active:scale-95 text-sm">×‘×¦×¢ COMMIT ×¡×•×¤×™</button>
    </div>

    <div id="pending-container" class="space-y-4"></div>

    <div id="editModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal p-4">
        <div class="bg-slate-900 border border-slate-700 w-full max-w-3xl rounded-3xl shadow-2xl overflow-hidden">
            <div class="p-6 border-b border-slate-800 bg-indigo-600/10 flex justify-between items-center">
                <h2 class="text-xl font-bold text-indigo-400">×¢×¨×™×›×ª ×¤×¨×˜×™ ×—×•×§×” ×œ×¤× ×™ ××™×©×•×¨</h2>
                <div id="modal-loader" class="hidden text-xs text-indigo-300 animate-pulse">×˜×•×¢×Ÿ × ×ª×•× ×™× ××”×¤×™×™×¨×•×•×œ...</div>
            </div>
            <div class="p-8 grid grid-cols-1 md:grid-cols-2 gap-6" id="editForm">
                <input type="hidden" id="edit_id">
                <div class="md:col-span-2 space-y-1">
                    <label class="text-xs text-slate-500 font-bold">×©× ×—×•×§×”</label>
                    <input id="edit_rule_name" class="w-full p-2.5 rounded-xl outline-none focus:border-indigo-500">
                </div>
                <div class="space-y-1">
                    <label class="text-xs text-slate-500 font-bold">From Zone</label>
                    <select id="edit_from_zone" class="w-full p-2.5 rounded-xl outline-none"></select>
                </div>
                <div class="space-y-1">
                    <label class="text-xs text-slate-500 font-bold">To Zone</label>
                    <select id="edit_to_zone" class="w-full p-2.5 rounded-xl outline-none"></select>
                </div>
                <div class="space-y-1">
                    <label class="text-xs text-slate-500 font-bold">Source IP / Object</label>
                    <select id="edit_source_ip" class="w-full p-2.5 rounded-xl outline-none"></select>
                </div>
                <div class="space-y-1">
                    <label class="text-xs text-slate-500 font-bold">Destination IP / Object</label>
                    <select id="edit_destination_ip" class="w-full p-2.5 rounded-xl outline-none"></select>
                </div>
                <div class="space-y-1">
                    <label class="text-xs text-indigo-400 font-bold">Application</label>
                    <input list="modal_app_list" id="edit_app" class="w-full p-2.5 rounded-xl outline-none">
                    <datalist id="modal_app_list"></datalist>
                </div>
                <div class="space-y-1">
                    <label class="text-xs text-slate-500 font-bold">Service / Port</label>
                    <select id="edit_port" class="w-full p-2.5 rounded-xl outline-none"></select>
                </div>
                <div class="space-y-1">
                    <label class="text-xs text-slate-500 font-bold">Tag (Normal)</label>
                    <select id="edit_tag" class="w-full p-2.5 rounded-xl outline-none"></select>
                </div>
                <div class="space-y-1">
                    <label class="text-xs text-orange-400 font-bold">Group Tag (G-)</label>
                    <input list="modal_group_tag_list" id="edit_group_tag" class="w-full p-2.5 rounded-xl outline-none border-dashed border border-orange-500/30">
                    <datalist id="modal_group_tag_list"></datalist>
                </div>
            </div>
            <div class="p-6 bg-slate-900/50 flex justify-end gap-3 border-t border-slate-800">
                <button onclick="closeEdit()" class="px-6 py-2 rounded-xl text-slate-400 hover:bg-slate-800 transition-all font-bold text-sm">×‘×™×˜×•×œ</button>
                <button onclick="saveEdit()" class="px-8 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-500 transition-all font-bold shadow-lg text-sm">×©××•×¨ ×¢×“×›×•×Ÿ</button>
            </div>
        </div>
    </div>

    <div id="rejectModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal">
        <div class="bg-slate-900 border border-slate-700 p-6 rounded-2xl w-full max-w-md shadow-2xl">
            <h3 class="text-xl font-bold text-rose-400 mb-4">×“×—×™×™×ª ×‘×§×©×ª ×—×•×§×”</h3>
            <p class="text-slate-400 text-sm mb-3">×¦×™×™×Ÿ ×¡×™×‘×” ×¢×‘×•×¨ ×”××©×ª××©:</p>
            <textarea id="rejectReason" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-4 text-white mb-6 h-32 outline-none" placeholder="×œ××” ×”×—×•×§×” × ×“×—×™×ª?"></textarea>
            <div class="flex justify-end gap-3 font-bold">
                <button onclick="closeRejectModal()" class="text-slate-400 hover:text-white px-4 py-2">×‘×™×˜×•×œ</button>
                <button id="confirmRejectBtn" class="bg-rose-600 hover:bg-rose-500 text-white px-6 py-2 rounded-xl">×“×—×” ×‘×§×©×”</button>
            </div>
        </div>
    </div>

    <script>
    let allRules = [];
    let firewallParams = null;
    let isFetchingParams = false;
    let ruleIdToReject = null;

    window.onload = function() { loadRules(); fetchFirewallParams(); };

    async function loadRules() {
        try {
            const res = await fetch('/get-admin-view-rules');
            allRules = await res.json();
            const pendingCount = allRules.filter(r => r.status === 'Pending').length;
            window.parent.postMessage({ type: 'UPDATE_COUNTER', source: 'rules', count: pendingCount }, '*');
            renderUI(allRules);
        } catch (e) { 
            document.getElementById('pending-container').innerHTML = '<p class="text-rose-500 text-center">×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×</p>';
        }
    }

    async function fetchFirewallParams() {
        if (firewallParams || isFetchingParams) return;
        isFetchingParams = true;
        try {
            const res = await fetch('/get-params');
            const data = await res.json();
            if (data.status === 'success') {
                firewallParams = data;
                populateModalDropdowns();
            }
        } catch (e) { console.error("Error params", e); }
        finally { isFetchingParams = false; }
    }

    function populateModalDropdowns() {
        if (!firewallParams) return;
        const fill = (id, items) => {
            const el = document.getElementById(id);
            if (el) el.innerHTML = items.map(i => `<option value="${i}">${i}</option>`).join('');
        };
        fill('edit_from_zone', firewallParams.zones);
        fill('edit_to_zone', firewallParams.zones);
        fill('edit_source_ip', firewallParams.addresses);
        fill('edit_destination_ip', firewallParams.addresses);
        fill('edit_port', firewallParams.services);
        fill('edit_tag', ["None", ...(firewallParams.tags || []).filter(t => !t.startsWith('G-'))]);
        document.getElementById('modal_group_tag_list').innerHTML = (firewallParams.tags || []).filter(t => t.startsWith('G-')).map(t => `<option value="${t}">${t}</option>`).join('');
        document.getElementById('modal_app_list').innerHTML = firewallParams.applications.map(a => `<option value="${a}">${a}</option>`).join('');
    }

    function renderUI(rules) {
        const container = document.getElementById('pending-container');
        if (!rules || rules.length === 0) {
            container.innerHTML = '<p class="text-slate-500 text-center py-10">××™×Ÿ ×—×•×§×•×ª ×œ×”×¦×’×”.</p>';
            return;
        }
        container.innerHTML = rules.map(r => {
            let statusClass = r.status === 'Approved' ? "rule-approved shadow-[0_0_15px_rgba(16,185,129,0.1)]" : r.status === 'Rejected' ? "rule-rejected shadow-[0_0_15px_rgba(239,68,68,0.1)]" : "border-slate-700";
            let statusBadge = r.status === 'Approved' ? '<span class="text-emerald-500 text-xs font-bold bg-emerald-500/10 px-3 py-1 rounded-full border border-emerald-500/20">××•×©×¨ âœ”</span>' : r.status === 'Rejected' ? '<span class="text-rose-500 text-xs font-bold bg-rose-500/10 px-3 py-1 rounded-full border border-rose-500/20">× ×“×—×” âœ˜</span>' : '<span class="text-orange-400 text-xs font-bold bg-orange-400/10 px-3 py-1 rounded-full border border-orange-400/20">×××ª×™×Ÿ â³</span>';
            
            return `
            <div class="rule-card bg-slate-800/40 border p-5 rounded-2xl flex justify-between items-center ${statusClass}">
                <div class="grid grid-cols-6 gap-4 flex-1 text-right text-sm items-center">
                    <div class="border-l border-slate-700/50 pl-2">
                        <p class="text-slate-500 text-[10px] mb-1 italic">××‘×§×©</p>
                        <p class="font-bold text-slate-200 truncate">${r.requested_by || '××¢×¨×›×ª'}</p>
                    </div>
                    <div><p class="text-slate-500 text-[10px] mb-1">×—×•×§×”</p><p class="text-indigo-400 text-xs font-bold truncate">${r.rule_name}</p></div>
                    <div><p class="text-slate-500 text-[10px] mb-1">Source</p><p class="text-slate-300 font-medium">${r.source_ip}</p></div>
                    <div><p class="text-slate-500 text-[10px] mb-1">Dest</p><p class="text-slate-300 font-medium">${r.destination_ip}</p></div>
                    <div><p class="text-slate-500 text-[10px] mb-1">App/Port</p><p class="text-slate-300 font-medium">${r.application} / ${r.service_port}</p></div>
                    <div class="flex flex-col items-center gap-1">
                        ${statusBadge}
                        ${r.admin_notes ? `<p class="text-[9px] text-rose-300 italic truncate max-w-[80px]">ğŸ’¬ ${r.admin_notes}</p>` : ''}
                    </div>
                </div>
                <div class="flex gap-2 mr-6">
                    ${r.status === 'Pending' ? `
                        <button onclick="openEdit(${r.id})" class="bg-slate-700 p-2 rounded-xl hover:bg-indigo-600 transition-all text-sm">ğŸ“</button>
                        <button onclick="openRejectModal(${r.id})" class="text-rose-400 border border-rose-600/30 px-3 py-2 rounded-xl text-[11px] font-bold hover:bg-rose-600">×“×—×™×™×”</button>
                        <button onclick="handleAction('approve', ${r.id}, false)" class="bg-slate-700 px-3 py-2 rounded-xl text-[11px] font-bold">××™×©×•×¨</button>
                        <button onclick="handleAction('approve', ${r.id}, true)" class="bg-indigo-600 px-3 py-2 rounded-xl text-[11px] font-bold shadow-lg">××™×©×•×¨+Commit</button>
                    ` : `<p class="text-[9px] text-slate-600 italic font-mono">${r.request_time || ''}</p>`}
                </div>
            </div>`;
        }).join('');
    }

    function openRejectModal(id) {
        ruleIdToReject = id;
        document.getElementById('rejectReason').value = "";
        document.getElementById('rejectModal').classList.remove('hidden');
    }
    function closeRejectModal() { document.getElementById('rejectModal').classList.add('hidden'); }

    document.getElementById('confirmRejectBtn').onclick = async function() {
        const reason = document.getElementById('rejectReason').value.trim();
        if(!reason) return alert("×—×•×‘×” ×¡×™×‘×”");
        try {
            const res = await fetch(`/reject-single-rule/${ruleIdToReject}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ reason: reason })
            });
            if((await res.json()).status === 'success') { closeRejectModal(); loadRules(); }
        } catch(e) { alert("×©×’×™××”"); }
    };

    async function openEdit(id) {
        const r = allRules.find(x => x.id === id);
        if (!r) return;
        document.getElementById('editModal').classList.remove('hidden');
        document.getElementById('edit_id').value = r.id;
        document.getElementById('edit_rule_name').value = r.rule_name;
        document.getElementById('edit_app').value = r.application;
        document.getElementById('edit_group_tag').value = r.group_tag || "";
        if (!firewallParams) await fetchFirewallParams();
        injectDataToModal(r);
    }

    function injectDataToModal(r) {
        const setVal = (id, val) => {
            const el = document.getElementById(id);
            if (!el) return;
            if (el.tagName === 'SELECT' && ![...el.options].some(o => o.value === val)) {
                el.add(new Option(val, val), el.firstChild);
            }
            el.value = val || (el.tagName === 'SELECT' ? "None" : "");
        };
        setVal('edit_from_zone', r.from_zone);
        setVal('edit_to_zone', r.to_zone);
        setVal('edit_source_ip', r.source_ip);
        setVal('edit_destination_ip', r.destination_ip);
        setVal('edit_port', r.service_port);
        setVal('edit_tag', r.tag);
    }

    function closeEdit() { document.getElementById('editModal').classList.add('hidden'); }

    async function saveEdit() {
        const id = document.getElementById('edit_id').value;
        const data = {
            rule_name: document.getElementById('edit_rule_name').value,
            from_zone: document.getElementById('edit_from_zone').value,
            to_zone: document.getElementById('edit_to_zone').value,
            source_ip: document.getElementById('edit_source_ip').value,
            destination_ip: document.getElementById('edit_destination_ip').value,
            application: document.getElementById('edit_app').value,
            service_port: document.getElementById('edit_port').value,
            tag: document.getElementById('edit_tag').value,
            group_tag: document.getElementById('edit_group_tag').value
        };
        const res = await fetch(`/update-pending-rule/${id}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        if ((await res.json()).status === 'success') { closeEdit(); loadRules(); }
    }

    async function handleAction(type, id, commit) {
        const url = type === 'approve' ? `/approve-single-rule/${id}` : `/reject-single-rule/${id}`;
        try {
            const res = await fetch(url, { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ reason: "××•×©×¨ ×¢×œ×™ ×™×“×™ ××“××™×Ÿ" }) 
            });
            if ((await res.json()).status === 'success') {
                if (commit) await commitAll();
                loadRules(); 
            }
        } catch (e) { alert("×©×’×™××”"); }
    }

    async function commitAll() {
        const res = await fetch('/commit', { method: 'POST' });
        const data = await res.json();
        alert(data.message || "Commit × ×©×œ×—.");
    }

    setInterval(loadRules, 15000);
</script>
</body>
</html>