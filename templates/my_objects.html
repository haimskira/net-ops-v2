<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Assistant', sans-serif; background-color: #0f172a; color: #f8fafc; padding: 20px; }
        .obj-card { transition: all 0.3s ease; border-color: #334155; }
        
        /* סטטוסים */
        .status-badge { padding: 4px 12px; border-radius: 999px; font-size: 11px; font-weight: bold; display: inline-flex; align-items: center; gap: 4px; }
        .status-pending, .status-Pending { color: #fbbf24; background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.2); }
        .status-approved, .status-Approved { color: #10b981; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2); }
        .status-rejected, .status-Rejected { color: #ef4444; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); }

        .admin-note { background: rgba(99, 102, 241, 0.05); border-right: 2px solid #6366f1; }
    </style>
</head>
<body>
    <div class="mb-6 bg-slate-900 p-6 rounded-2xl border border-slate-800 shadow-xl flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold text-purple-400">סטטוס אובייקטים</h1>
            <p class="text-slate-500 text-sm">הנתונים מתעדכנים אוטומטית</p>
        </div>
        <div id="refresh-indicator" class="w-2 h-2 rounded-full bg-emerald-500/50 animate-pulse" title="מחובר לשרת"></div>
    </div>

    <div id="my-objects-container" class="space-y-4">
        <div id="initial-loader" class="text-center py-10">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-purple-500"></div>
            <p class="text-slate-500 mt-2 text-sm">טוען נתונים...</p>
        </div>
    </div>

    <script>
        let isFirstLoad = true;
        let lastDataString = ""; 

        async function loadMyObjects() {
            const indicator = document.getElementById('refresh-indicator');
            try {
                const res = await fetch(`/get-my-objects?t=${Date.now()}`);
                const data = await res.json();
                
                const currentDataString = JSON.stringify(data);
                if (currentDataString !== lastDataString) {
                    renderUI(data);
                    lastDataString = currentDataString;
                }

                indicator.classList.replace('bg-rose-500', 'bg-emerald-500');
            } catch (e) {
                indicator.classList.replace('bg-emerald-500', 'bg-rose-500');
                if (isFirstLoad) {
                    document.getElementById('my-objects-container').innerHTML = '<p class="text-rose-500 text-center">שגיאה בתקשורת עם השרת</p>';
                }
            } finally {
                if (isFirstLoad) {
                    const loader = document.getElementById('initial-loader');
                    if (loader) loader.remove();
                    isFirstLoad = false;
                }
            }
        }

        function renderUI(objects) {
            const container = document.getElementById('my-objects-container');
            
            if (!objects || objects.length === 0) {
                container.innerHTML = '<p class="text-slate-500 text-center py-10 italic border border-dashed border-slate-800 rounded-xl">טרם הגשת בקשות.</p>';
                return;
            }

            container.innerHTML = objects.map(o => {
                // טיפול בשמות שדות מה-DB
                const type = o.obj_type || o.type || 'UNKNOWN';
                const status = o.status || 'Pending';
                
                let displayVal = o.value || '';
                if (type.includes('address') && o.prefix) displayVal += `/${o.prefix}`;
                if (type.includes('service') && o.protocol) displayVal += ` <span class="text-indigo-400 text-[10px] font-bold">[${o.protocol.toUpperCase()}]</span>`;

                let statusIcon = status.toLowerCase() === 'pending' ? '⏳' : status.toLowerCase() === 'approved' ? '✔' : '✘';
                let statusLabel = status.toLowerCase() === 'pending' ? 'ממתין' : status.toLowerCase() === 'approved' ? 'אושר' : 'נדחה';

                return `
                <div class="obj-card bg-slate-800/40 border p-4 rounded-2xl shadow-lg hover:bg-slate-800/60 transition-all">
                    <div class="flex justify-between items-center">
                        <div class="grid grid-cols-4 gap-4 flex-1 text-right text-sm items-center">
                            <div class="border-l border-slate-700/50 pl-4">
                                <p class="text-slate-500 text-[10px] mb-0.5 italic">שם אובייקט</p>
                                <p class="font-bold text-indigo-300 font-mono truncate" title="${o.name}">${o.name}</p>
                            </div>

                            <div>
                                <p class="text-slate-500 text-[10px] mb-0.5">סוג</p>
                                <p class="text-slate-200 text-[11px] font-bold uppercase tracking-wider">${type.replace('-', ' ')}</p>
                            </div>

                            <div>
                                <p class="text-slate-500 text-[10px] mb-0.5">ערך</p>
                                <p class="text-slate-300 font-mono text-xs truncate">${displayVal}</p>
                            </div>

                            <div class="flex justify-end pl-2">
                                <span class="status-badge status-${status}">
                                    ${statusLabel} ${statusIcon}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    ${o.admin_notes ? `
                    <div class="mt-3 p-3 admin-note rounded-lg">
                        <p class="text-[10px] text-indigo-400 font-bold mb-1">הערת אדמין:</p>
                        <p class="text-xs text-slate-300 italic">${o.admin_notes}</p>
                    </div>
                    ` : ''}
                </div>`;
            }).join('');
        }

        loadMyObjects();
        setInterval(loadMyObjects, 5000); // 5 שניות זה מספיק מהיר ומעמיס פחות
    </script>
</body>
</html>