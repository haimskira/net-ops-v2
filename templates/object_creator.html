<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    
    <style>
        body { font-family: 'Assistant', sans-serif; background-color: #0f172a; color: #f8fafc; }
        
        /* 爪 住驻专 */
        .spinner { 
            border-top-color: transparent !important; 
            animation: rot 1s linear infinite; 
        }
        @keyframes rot { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* 转转 Choices.js -Dark Mode */
        .choices__inner { 
            border-radius: 0.75rem !important; 
            background-color: #1e293b !important; 
            border: 1px solid #334155 !important; 
            padding: 8px !important;
            color: #f8fafc !important;
        }
        .choices__list--dropdown, .choices__list[aria-expanded] {
            background-color: #1e293b !important;
            border: 1px solid #334155 !important;
            color: #f8fafc !important;
        }
        .choices__list--dropdown .choices__item--selectable.is-highlighted {
            background-color: #4f46e5 !important;
        }
        .choices__list--multiple .choices__item { 
            background-color: #4f46e5 !important; 
            border: none !important; 
            border-radius: 6px !important; 
            font-weight: 600; 
        }
        input::placeholder { color: #64748b !important; }
    </style>
</head>
<body class="p-6">
    <div class="max-w-2xl mx-auto bg-slate-800/50 border border-slate-700 rounded-3xl p-8 shadow-2xl backdrop-blur-sm">
        
        <div class="flex items-center justify-between mb-6 border-b border-slate-700 pb-4">
            <h2 class="text-2xl font-bold text-indigo-400 flex items-center gap-2">
                <span></span> 爪专转 拽 砖
            </h2>
            
            <div id="loading-indicator" class="flex items-center gap-2 bg-slate-900/80 px-4 py-1.5 rounded-full border border-indigo-500/30 shadow-inner">
                <div class="spinner w-3.5 h-3.5 border-2 border-indigo-400 rounded-full"></div>
                <span class="text-xs font-medium text-slate-300">注 拽...</span>
            </div>
        </div>
        
        <div class="space-y-5">
            <div>
                <label class="block text-sm font-bold text-slate-400 mb-2">住 拽</label>
                <select id="type" onchange="updateUI()" class="w-full border border-slate-700 p-3 rounded-xl bg-slate-900 text-slate-200 outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                    <option value="address">Address (IP)</option>
                    <option value="address-group">Address Group</option>
                    <option value="service">Service (Port)</option>
                    <option value="service-group">Service Group</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-bold text-slate-400 mb-2">砖 拽</label>
                <input type="text" id="name" placeholder="砖: SERVER_HTTPS_PORT" class="w-full border border-slate-700 p-3 rounded-xl bg-slate-900 text-slate-200 outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
            </div>

            <div id="single-value-container">
                <label id="value-label" class="block text-sm font-bold text-slate-400 mb-2">注专</label>
                <div class="flex gap-2">
                    <input type="text" id="value" placeholder="" class="flex-1 border border-slate-700 p-3 rounded-xl bg-slate-900 text-slate-200 outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                    
                    <select id="prefix_container" class="w-24 border border-slate-700 p-3 rounded-xl bg-slate-900 text-slate-200 outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="32">/32</option>
                        <option value="24">/24</option>
                    </select>

                    <select id="protocol_container" class="w-28 border border-slate-700 p-3 rounded-xl bg-slate-900 text-slate-200 outline-none focus:ring-2 focus:ring-indigo-500 hidden">
                        <option value="tcp">TCP</option>
                        <option value="udp">UDP</option>
                    </select>
                </div>
            </div>

            <div id="multi-select-container" class="hidden">
                <label id="multi-label" class="block text-sm font-bold text-slate-400 mb-2">专 专 专砖</label>
                <select id="members_select" class="w-full" multiple></select>
            </div>
        </div>

        <button onclick="createObj()" id="btn" class="w-full mt-10 bg-indigo-600 text-white font-bold py-4 rounded-2xl hover:bg-indigo-500 transition-all shadow-lg shadow-indigo-500/20 active:scale-[0.98]">
            爪专 拽 注专转
        </button>
        
        <div id="status" class="mt-6 p-4 rounded-xl hidden text-center font-bold border"></div>
    </div>

    <script>
        let multiSelect;
        
        // --- 驻拽爪转 爪 砖转 ---
        function isValidIPv4(ip) {
            const regex = /^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
            return regex.test(ip);
        }

        function isValidPort(port) {
            const p = parseInt(port, 10);
            return !isNaN(p) && p >= 1 && p <= 65535; //  驻专 拽
        }

        function showError(msg) {
            const status = document.getElementById('status');
            status.classList.remove('hidden');
            status.className = "mt-6 p-4 rounded-xl text-center font-bold border-rose-500/50 bg-rose-500/10 text-rose-400";
            status.innerText = "砖: " + msg;
            
            // 住转专转 注 专 3 砖转
            setTimeout(() => {
                 status.classList.add('hidden');
            }, 3000);
        }
        // ------------------------------

        document.addEventListener('DOMContentLoaded', () => {
            const element = document.getElementById('members_select');
            multiSelect = new Choices(element, {
                removeItemButton: true,
                placeholderValue: '专 驻专...',
                noChoicesText: ' 爪 转',
                itemSelectText: '抓 专',
                searchEnabled: true,
            });
            updateUI();
        });

        async function updateUI() {
            // (转 拽 拽  拽 -  砖转)
            const type = document.getElementById('type').value;
            const singleCont = document.getElementById('single-value-container');
            const multiCont = document.getElementById('multi-select-container');
            const prefix = document.getElementById('prefix_container');
            const protocol = document.getElementById('protocol_container');
            const valueInput = document.getElementById('value');
            const valueLabel = document.getElementById('value-label');

            singleCont.classList.add('hidden');
            multiCont.classList.add('hidden');
            prefix.classList.add('hidden');
            protocol.classList.add('hidden');
            multiSelect.clearChoices();

            if (type === 'address') {
                singleCont.classList.remove('hidden');
                prefix.classList.remove('hidden');
                valueLabel.innerText = "转转 IP";
                valueInput.placeholder = "1.1.1.1";
            } 
            else if (type === 'service') {
                singleCont.classList.remove('hidden');
                protocol.classList.remove('hidden');
                valueLabel.innerText = "驻专 注 (Destination Port)";
                valueInput.placeholder = "443";
            } 
            else if (type === 'address-group') {
                multiCont.classList.remove('hidden');
                document.getElementById('multi-label').innerText = "专 拽 Address";
                loadChoices('/get-address-objects', 'addresses');
            } 
            else if (type === 'service-group') {
                multiCont.classList.remove('hidden');
                document.getElementById('multi-label').innerText = "专 拽 Service";
                loadChoices('/get-service-objects', 'services');
            }
        }

        async function loadChoices(url, dataKey) {
            // (转 拽 拽  拽 -  砖转)
            document.getElementById('loading-indicator').classList.remove('hidden');
            multiSelect.clearStore();
            try {
                const res = await fetch(url);
                const data = await res.json();
                if (data.status === 'success') {
                    const items = data[dataKey].map(name => ({ value: name, label: name }));
                    multiSelect.setChoices(items, 'value', 'label', true);
                }
            } catch (e) { console.error("Error loading data", e); }
            document.getElementById('loading-indicator').classList.add('hidden');
        }

        async function createObj() {
            const btn = document.getElementById('btn');
            const type = document.getElementById('type').value;
            const name = document.getElementById('name').value.trim();
            let value;

            // 1. 拽转 砖
            if (!name) { showError("  砖 拽"); return; }
            // 拽 砖砖   专  转 住专 (驻爪  抓)
            if (/[^a-zA-Z0-9_\-]/.test(name)) { showError("砖 拽   专拽 转转 转, 住驻专, 拽祝  拽 转转"); return; }

            // 2. 拽转 注专 驻 住
            if (type.includes('group')) {
                const selected = multiSelect.getValue(true);
                if (selected.length === 0) { showError(" 专 驻转 专  拽爪"); return; }
                value = selected.join(',');
            } else {
                value = document.getElementById('value').value.trim();
                if (!value) { showError("  注专"); return; }

                // ---  住转 爪 砖 ---
                if (type === 'address') {
                    if (!isValidIPv4(value)) {
                        showError("转转 -IP 砖  转拽 (驻专 砖  住驻专 抓 )");
                        return;
                    }
                } else if (type === 'service') {
                    if (!isValidPort(value)) {
                        showError("住驻专 驻专  转拽 ( 转 住驻专  1 -65535)");
                        return;
                    }
                }
                // --------------------------------
            }

            const payload = {
                type: type,
                name: name,
                value: value,
                prefix: document.getElementById('prefix_container').value,
                protocol: document.getElementById('protocol_container').value
            };

            btn.disabled = true;
            btn.innerText = "注...";
            
            try {
                const res = await fetch('/create-object', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                
                const status = document.getElementById('status');
                status.classList.remove('hidden');
                status.innerText = data.message;
                
                if (data.status === 'success') {
                    status.className = "mt-6 p-4 rounded-xl text-center font-bold border-emerald-500/50 bg-emerald-500/10 text-emerald-400";
                    // 拽 驻住 爪
                    document.getElementById('name').value = "";
                    document.getElementById('value').value = "";
                    if(multiSelect) multiSelect.removeActiveItems();
                } else {
                    status.className = "mt-6 p-4 rounded-xl text-center font-bold border-rose-500/50 bg-rose-500/10 text-rose-400";
                }
            } catch (e) { showError("砖 转拽砖专转"); }
            finally { 
                btn.disabled = false; 
                btn.innerText = "爪专 拽 注专转";
            }
        }
    </script>
</body>
</html>